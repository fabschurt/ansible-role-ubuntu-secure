---
- name: Upload GRUB config file
  tags: [config]
  template:
    src: etc/default/grub
    dest: /etc/default/grub
    mode: 0644
  notify:
    - Update GRUB

- name: Upload miscellaneous config files
  tags: [config]
  copy:
    src: '{{ item }}'
    dest: '/{{ item }}'
    mode: "{{ (item == 'etc/sudoers')|ternary('0440', '0644') }}"
  with_items:
    - etc/apt/apt.conf.d/
    - etc/sudoers
    - etc/sysctl.conf
    - etc/modprobe.d/blacklist.conf
    - etc/default/rkhunter
  notify:
    - Reboot server

- name: Upload firewall (iptables) config
  tags: [config]
  template:
    src: etc/network/if-pre-up.d/iptables
    dest: /etc/network/if-pre-up.d/iptables
    mode: 0755
  notify:
    - Reboot server

- name: Check if Postfix config file exists
  tags: [config]
  stat:
    path: /etc/postfix/main.cf
  register: postfix_config_file

- name: Disable ipv6 support in Postfix
  tags: [config]
  lineinfile:
    regexp: '^inet_protocols\s+(?:all|ipv4,\s*ipv6)$'
    line: 'inet_protocols ipv4'
    state: present
    dest: /etc/postfix/main.cf
  when: postfix_config_file.stat.exists
